# Backend
## création du modèle
```
$ git clone https://github.com/etalab/radar-tech-backend.git
$ cd radar-tech-backend
$ cd scripts
$ node createSchema <path to json file>
$ cd ..
```

## Creation de l'application Dokku
```
export DOKKU_HOST='studio-01.infra.data.gouv.fr'
export DOKKU_PORT='22'
dokku apps:create <app_name>
```
### Ajouter des variables d'environnement
```
dokku config:set API_URL=http://radartech-0206.app.etalab.studio
dokku config:set ACCESS_TOKEN_TYPE='Bearer'
dokku config:set ACCESS_TOKEN_ALGORITHM='HS256'
dokku config:set ACCESS_TOKEN_SECRET='<token_secret>'
dokku config:set SIB_API_KEY=<sendinblue_api_key>
```
`<token_secret>` correspond à la clé secrète utilisé pour généré les token

## Création de la base de données
```
$ dokku mongo:create <mongo_service_name>
$ dokku mongo:link <mongo_service_name> <app_name>
```
Dans le résultat retourné `Dsn` coorrespond à l'adresse de connexion à la DB, au format : `mongodb://<service_name>:2652096c746158e0fd896ff2b7416877@<service_user>:27017/<db_name>`
La commande Link a automatiquement ajouté l'URL vers Mongo en variable d'environnement.

A ce stade il doit y avoir 6 variables d'environnement
Pour vérifier il est possible de les lister
```
$ dokku config:show
> 
ACCESS_TOKEN_ALGORITHM:  HS256
ACCESS_TOKEN_SECRET:     <token_secret>
ACCESS_TOKEN_TYPE:       Bearer
API_URL:                 http://<app_name>.app.etalab.studio
MONGO_URL:               mongodb://<mongo_service_name>:<number_generated_by_dokku_service>@dokku-mongo-<mongo_service_name>:27017/<db_name>
SIB_API_KEY:             <sendinblue_api_key>
```

## Tester
```
$ cd ..
$ npm install
$ npm run dev
```

## Creer un token
En amont il faut créer un utilisateur manuellement (à améliorer)
Il n'y a pas d'interface d'administration, donc la création de l'utilisateur est semi-automatisée.

### Créer le salt et hash d'un mot de passe
```
$ cd script
$ node createHashAndSalt.js <username> <password>
```
le salt et le mot de passe hashé sont affichées en console

### Créer un utilisateur en base de données 
```
dokku mongo:connect <db_name>
> use <nom de la db>
> db.users.insert({ username: 'frontend-app', role: 'frontend', password: '51407e040228a336a4db37684ce7ee9aee73c457a988b0493cb62930f0dfcf59', salt: '1c66ebc09fcf320a9189215c94bd93d8' })
```
Le nom de la DB est indiqué à la fin de l'url de connexion `mongodb://<service_name>:2652096c746158e0fd896ff2b7416877@<service_user>:27017/<db_name>`

### Générer un token semi manuellement 
Une route est dédiée à la génération du token
#### Exemple avec CURL
```
curl --location --request POST 'http://radartech-0206.app.etalab.studio/token' \
--header 'Content-Type: application/json' \
--data-raw '{
    "username": "audrey",
    "password": "51407e040228a336a4db37684ce7ee9aee73c457a988b0493cb62930f0dfcf59"
}'
```

#### Exemple avec Nodejs Request
```
var request = require('request');
var options = {
  'method': 'POST',
  'url': 'http://<nom_app>.app.etalab.studio/token',
  'headers': {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({"username":"frontend","password":"<password>"})

};
request(options, function (error, response) {
  if (error) throw new Error(error);
  console.log(response.body);
});
```

## Lancer l'application
Un nouveau schema a été généré, branche doit être créée avec ces modifications.
```
$ git checkout -B deploy
$ git add src/
$ git commit -m "generate schema"
$ git push dokku deploy:master
```

# Frontend
## Récupération du projet
```
git clone https://github.com/etalab/radar-tech-frontend.git
cd radar-tech-frontend
git checkout test/deployApp
``` 
## Ajout du fichier décrivant les questionnaires
```
cd ..
mv <metier>.json radar-tech-frontend/pages-metiers/<metier>.json
```
## Tester 
Créez un fichier de variables d'environnemen `.env.development`en copiant `.env_example`: 
```
GATSBY_API_URL=http://<app_name>.app.etalab.studio/graphql
GATSBY_API_TOKEN=<token généré>
```
```
$ npm install
$ npm run develop
```
## Créer l'application dokku
### Configurer Dokku
```
$ export DOKKU_HOST='studio-01.infra.data.gouv.fr'
$ export DOKKU_PORT='22'
```
### Création d'une nouvelle application
```
$ dokku apps:create <app_name>
```
### Ajouter les variables d'environnement
Le token pour accéder à l'API a été généré en amont.
Se référer à la section [Créer un token](#Creer-un-token) 
Créer un fichier .env.production et ajouter les variables suivantes
```
GATSBY_API_URL=<backend_url>
GATSBY_API_TOKEN=<token generated by backend APP>
```
Créer une nouvelle branche de déploiement
Ajouter les nouveaux questionnaires au format JSON
Forcer l'ajouter du fichier de configuration
Pousser la nouvelle branche sur le dépôt distant dokku
Attention : il ne faut pas pousser cette branche sur le répo d'origine, elle contient le fichier d'environnement
```
$ git checkout -b deploy
$ git add git add pages-metiers/<nom du fichier ajouté>
$ git add -f .env.production
$ git commit -m "add schema"
$ git push dokku deploy:master
```
### Lancer l'application
```
$ git push dokku master
```
Si une nouvelle branche a été créée pour le déploiement
``` 
$ git push dokku <branch>:master
```

# Des pistes d'amélioration 
- automatiser toutes ces étapes
- Ajouter une interface d'administration
- J'ai plusieurs fichiers en entrée avec un clé. Cette clé représente le nom du modèle. Je peux générer des modèles en fonctions des fichiers: 
   - soit j'exécute le script sur un dossier
   - soit on exécute plusieurs fois le scripts avec des noms de fichiers en entrée
   - soit on a un fichier yaml et on récupère la liste des fichiers